/* ====================================================
   DecisionCard MVP - Mobile Enhancements
   ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©
==================================================== */

// Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡Ø§ØªÙ
function isMobile() {
  return window.innerWidth <= 767;
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„
function showMobileToast(message, type = "info", duration = 3000) {
  if (!isMobile()) return;
  
  const toast = document.createElement("div");
  toast.className = `mobile-toast ${type}`;
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: ${type === "success" ? "#38a169" : 
                 type === "error" ? "#e53e3e" : 
                 type === "warning" ? "#ed8936" : "#3182ce"};
    color: white;
    padding: 14px 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 10000;
    text-align: center;
    font-weight: 500;
    font-size: 15px;
    max-width: 90%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    backdrop-filter: blur(10px);
    animation: slideUpMobile 0.3s ease-out;
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = "0";
    toast.style.transform = "translateX(-50%) translateY(10px)";
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

// Ø¥Ø¶Ø§ÙØ© Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ù„Ù„ØªÙˆØ³Øª
const toastStyle = document.createElement('style');
toastStyle.textContent = `
  @keyframes slideUpMobile {
    from { 
      opacity: 0; 
      transform: translateX(-50%) translateY(20px); 
    }
    to { 
      opacity: 1; 
      transform: translateX(-50%) translateY(0); 
    }
  }
`;
document.head.appendChild(toastStyle);

document.addEventListener('DOMContentLoaded', function() {
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù†Ù†Ø§ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² Ù…Ø­Ù…ÙˆÙ„
  if (!isMobile()) return;
  
  // ========== ØªØ­Ø³ÙŠÙ†Ø§Øª ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ==========
  
  // 1. Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ù„Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰
  addScrollToTopButton();
  
  // 2. ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙˆØ§ØªÙ
  enhanceTextInputExperience();
  
  // 3. Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ¨ÙŠØ± ÙÙŠ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
  preventInputZoom();
  
  // 4. ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
  enhanceModalExperience();
  
  // 5. Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
  addLoadingIndicator();
  
  // 6. ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙ†Ù‚Ù„
  enhanceNavigation();
});

// ========== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ==========

function addScrollToTopButton() {
  const scrollBtn = document.createElement('button');
  scrollBtn.innerHTML = 'â†‘';
  scrollBtn.className = 'mobile-scroll-top';
  scrollBtn.setAttribute('aria-label', 'Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù„Ù‰');
  scrollBtn.style.cssText = `
    position: fixed;
    bottom: 20px;
    left: 20px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--accent);
    color: white;
    border: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 9999;
    font-size: 20px;
    display: none;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.3s, transform 0.3s;
    touch-action: manipulation;
  `;
  
  document.body.appendChild(scrollBtn);
  
  // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø± Ø­Ø³Ø¨ Ø§Ù„ØªÙ…Ø±ÙŠØ±
  window.addEventListener('scroll', () => {
    if (window.scrollY > 300) {
      scrollBtn.style.display = 'flex';
      setTimeout(() => scrollBtn.style.opacity = '1', 10);
    } else {
      scrollBtn.style.opacity = '0';
      setTimeout(() => {
        if (scrollBtn.style.opacity === '0') {
          scrollBtn.style.display = 'none';
        }
      }, 300);
    }
  });
  
  // Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø±
  scrollBtn.addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
    scrollBtn.style.transform = 'scale(0.9)';
    setTimeout(() => scrollBtn.style.transform = 'scale(1)', 300);
  });
}

function enhanceTextInputExperience() {
  // Ø¬Ø¹Ù„ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Øµ Ø£Ø³Ù‡Ù„ Ù„Ù„ÙƒØªØ§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙˆØ§ØªÙ
  const textInputs = document.querySelectorAll('input[type="text"], textarea');
  
  textInputs.forEach(input => {
    // ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙˆØ§ØªÙ
    input.addEventListener('focus', function() {
      setTimeout(() => {
        const rect = this.getBoundingClientRect();
        if (rect.top < 100 || rect.bottom > window.innerHeight - 200) {
          this.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
          });
        }
      }, 300);
    });
  });
}

function preventInputZoom() {
  // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ iOS Ø¹Ù†Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„
  const viewport = document.querySelector('meta[name="viewport"]');
  if (!viewport) return;
  
  const originalContent = viewport.content;
  
  function disableZoom() {
    viewport.content = originalContent + ', maximum-scale=1';
  }
  
  function enableZoom() {
    viewport.content = originalContent;
  }
  
  const inputs = document.querySelectorAll(
    'input:not([type="range"]):not([type="checkbox"]):not([type="radio"]), ' +
    'textarea, select'
  );
  
  inputs.forEach(input => {
    input.addEventListener('focus', disableZoom);
    input.addEventListener('blur', enableZoom);
  });
}

function enhanceModalExperience() {
  const modal = document.getElementById('modalDecision');
  if (!modal) return;
  
  // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§Ù„Ø³Ø­Ø¨ Ù„Ø£Ø³ÙÙ„
  let touchStartY = 0;
  let modalContent = modal.querySelector('.panel');
  
  modalContent.addEventListener('touchstart', function(e) {
    if (this.scrollTop === 0) {
      touchStartY = e.touches[0].clientY;
    }
  }, { passive: true });
  
  modalContent.addEventListener('touchmove', function(e) {
    if (this.scrollTop > 0) return;
    
    const currentY = e.touches[0].clientY;
    const diff = currentY - touchStartY;
    
    if (diff > 0) { // Ø§Ù„Ø³Ø­Ø¨ Ù„Ø£Ø³ÙÙ„ ÙÙ‚Ø·
      this.style.transform = `translateY(${diff}px)`;
    }
  }, { passive: true });
  
  modalContent.addEventListener('touchend', function(e) {
    const currentY = e.changedTouches[0].clientY;
    const diff = currentY - touchStartY;
    
    this.style.transition = 'transform 0.3s ease';
    
    if (diff > 100) { // Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø³Ø­Ø¨ Ù„Ø£Ø³ÙÙ„ Ø£ÙƒØ«Ø± Ù…Ù† 100px
      modal.classList.remove('open');
      document.body.style.overflow = 'auto';
    }
    this.style.transform = 'translateY(0)';
  }, { passive: true });
}

function addLoadingIndicator() {
  // Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± ØªØ­Ù…ÙŠÙ„ Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø·ÙˆÙŠÙ„Ø©
  const style = document.createElement('style');
  style.textContent = `
    .mobile-loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      backdrop-filter: blur(5px);
    }
    
    .mobile-loading-spinner {
      width: 50px;
      height: 50px;
      border: 3px solid var(--line);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: mobile-spin 1s linear infinite;
    }
    
    .mobile-loading-text {
      margin-top: 1rem;
      color: var(--text);
      font-weight: 500;
    }
    
    @keyframes mobile-spin {
      to { transform: rotate(360deg); }
    }
  `;
  document.head.appendChild(style);
  
  const loadingDiv = document.createElement('div');
  loadingDiv.className = 'mobile-loading';
  loadingDiv.innerHTML = `
    <div class="mobile-loading-spinner"></div>
    <div class="mobile-loading-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
  `;
  document.body.appendChild(loadingDiv);
  
  // ÙˆØ¸Ø§Ø¦Ù Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
  window.showMobileLoading = (text = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...') => {
    loadingDiv.querySelector('.mobile-loading-text').textContent = text;
    loadingDiv.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  };
  
  window.hideMobileLoading = () => {
    loadingDiv.style.display = 'none';
    document.body.style.overflow = 'auto';
  };
}

function enhanceNavigation() {
  // ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨Ø§Ù„Ø£ØµØ§Ø¨Ø¹
  const buttons = document.querySelectorAll('.btn, button');
  buttons.forEach(btn => {
    btn.addEventListener('touchstart', function() {
      this.style.transform = 'scale(0.95)';
      this.style.transition = 'transform 0.1s';
    }, { passive: true });
    
    btn.addEventListener('touchend', function() {
      this.style.transform = 'scale(1)';
    }, { passive: true });
    
    btn.addEventListener('touchcancel', function() {
      this.style.transform = 'scale(1)';
    }, { passive: true });
  });
}

// Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø©
let resizeTimeout;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(() => {
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¥Ø°Ø§ ØªØºÙŠØ± Ù…Ù† Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± Ø£Ùˆ Ø§Ù„Ø¹ÙƒØ³
    if (typeof route === 'function') {
      route();
    }
  }, 250);
});

// ========== ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© ==========

// ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
window.addEventListener('load', () => {
  // Ø¥Ø¶Ø§ÙØ© Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„Ù‰
  if (!localStorage.getItem('dc_first_visit_mobile') && isMobile()) {
    setTimeout(() => {
      const welcomeMsg = document.createElement('div');
      welcomeMsg.className = 'mobile-welcome';
      welcomeMsg.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--accent);
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        z-index: 10001;
        text-align: center;
        animation: fadeOut 0.5s ease 2s forwards;
      `;
      
      welcomeMsg.innerHTML = `
        <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ‘‹</div>
        <h2 style="margin-bottom: 1rem; font-size: 1.5rem;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ DecisionCard</h2>
        <p style="margin-bottom: 2rem; line-height: 1.5; font-size: 1rem;">
          Ø§Ù†Ù…ÙˆØ°Ø¬ ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù‡Ø¬ÙŠÙ† Ù…Ø¹ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
        </p>
        <div style="font-size: 0.9rem; opacity: 0.8;">
          Ø§Ø³Ø­Ø¨ Ù„Ù„ÙŠØ³Ø§Ø± ÙˆØ§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª
        </div>
      `;
      
      document.body.appendChild(welcomeMsg);
      
      // Ø¥Ø¶Ø§ÙØ© Ø£Ù†ÙŠÙ…ÙŠØ´Ù†
      const style = document.createElement('style');
      style.textContent = `
        @keyframes fadeOut {
          to { opacity: 0; visibility: hidden; }
        }
      `;
      document.head.appendChild(style);
      
      localStorage.setItem('dc_first_visit_mobile', 'true');
    }, 1000);
  }
});